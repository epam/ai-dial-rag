# DIAL RAG API Documentation

The DIAL RAG API allows you to customize what parts of the RAG pipeline you want to use. In general, the DIAL RAG pipeline consists of the following steps:
- **Indexing** - the process of parsing the documents and creating an index of the document chunks. By default, DIAL RAG handles the storage of the document indexes.
- **Retrieval** - the process of retrieving relevant chunks of documents based on the user query. By default, DIAL RAG automatically finds the index for the documents in the request and runs the indexing if the documents were not indexed before.
- **Generation** - the process of generating a response based on the retrieved document chunks and the user query.

The DIAL RAG API allows you to run parts of the RAG pipeline depending on your use case. For example, you can use the Retrieval API to get relevant document chunks and then run your custom LLM pipeline on top of them. Or you can use the Indexing API to manually index documents and use custom paths to store the index files in the DIAL storage.


## Chat completions API

The DIAL RAG is implemented as a DIAL Application. As a DIAL Application, it provides the `/chat/completions` endpoint as part of the [DIAL Unified API](https://docs.dialx.ai/platform/architecture-and-concepts/concepts#unified-api) which allows to interact with the DIAL RAG pipeline from the [DIAL Chat UI](https://docs.dialx.ai/platform/chat/about-chat) or as an API calls from other applications.

The DIAL Unified API uses [`custom_content.attachments`](https://docs.dialx.ai/tutorials/developers/chat/chat-objects#attachments) field of the message to attach the files as inputs or outputs for the applications. The DIAL RAG API uses this field to send the documents for indexing and retrieval, and to return the retrieved documents in the response.

Additionally, the DIAL RAG uses the [`custom_fields.configuration`](https://dialx.ai/dial_api#operation/configurationDeployment) field of the Unified API to configure the RAG pipeline.

You can look at the autogenerated [DIAL RAG Configuration schema](./configuration.generated.schema.json) to see all other the available configuration options for the DIAL RAG pipeline.

## Indexing and Retrieval API

Indexing and Retrieval API allows you to use the parts of the DIAL RAG pipeline. It is based on the DIAL Unified API and works via the same `/chat/completions` endpoint.
To run the Indexing or Retrieval part of the RAG pipeline, you need to set the `custom_fields.configuration.request.type` field in the request body. The DIAL RAG supports the following request types:
- **`rag`** - used by default if no type is specified. Runs the full RAG pipeline, including indexing (if documents were not indexed before), retrieval, and generation of the final response.
- **`indexing`** - runs the indexing process and return the index files in the response.
- **`retrieval`** - runs the retrieval process and returns the retrieved document chunks in the response without generating a response. May also run the indexing process if the documents were not indexed before.


### Index attachments

The DIAL RAG uses special type of attachments to represent the index files for the documents. The index attachments are used both as output of the indexing requests and as an input for the retrieval or RAG requests.

The DIAL RAG recognizes the index attachment by MIME types matching `application/x.aidial-rag.index.*`. Currently, only index type `application/x.aidial-rag.index.v0` is supported, but it may be extended in the new versions of the DIAL RAG.

The index attachment is based on the [DIAL Unified API attachments](https://docs.dialx.ai/tutorials/developers/chat/chat-objects#attachments) and has the following structure:

```json
{
    "type": "application/x.aidial-rag.index.v0",
    "url": "files/<bucket>/<path to index file>",
    "reference_url": "<url to the document the index file is based on>"
}
```
The index attachment should use `url` field to point to the index file in the DIAL storage. The `data` field for the embedded file content is not supported.
The `reference_url` field is used to point to the document the index file is based on, which is useful for the retrieval requests to find the original document. The `reference_url` is required for the index attachments.

### Indexing parameters

There are following parameters could be specified for `custom_fields.configuration.request.` to control the indexing behavior:

- **`force_indexing`** (default: false) - If set to true, DIAL RAG will not check if the index already exists and will re-index the documents regardless.

- **`allow_indexing`** (default: true) - If set to false, DIAL RAG will not run the indexing process. DIAL RAG will only check if the index exists and is compatible with the current version and settings. If the index is missing or incompatible, the indexing process will be skipped and the error will be returned.

### Indexing Request

The indexing request is a `/chat/completion` request with `custom_fields.configuration.request.type` field to `indexing` in the request body.
You should attach the documents to be indexed as a list of attachments in the `custom_content.attachments` field.

Optionally, you can specify the desired location for the index files as [index attachments](#index-attachments). If no index attachments are specified, the DIAL RAG will automatically create the index files in the DIAL RAG bucket with a path based on the document URL. If the index attachments are specified, the DIAL RAG will use them to store the index files in the specified location.

Example of the indexing request for a single `my_document.pdf` document:
```json
{
    "custom_fields": {
        "configuration": {
            "request": {
                "type": "indexing"
            }
        }
    },
    "messages": [
        {
            "role": "user",
            "custom_content": {
                "attachments": [
                    {
                        "type": "application/pdf",
                        "url": "files/<bucket>/my_document.pdf"
                    }
                ]
            }
        }
    ]
}
```

The response for this request will have a message with an empty content (because the generation of the final response is not run) and a list of index attachments in the `custom_content.attachments` field for all the documents which were indexed successfully.

Additionally, the response will contain an attachment JSON representation of indexing results which will be useful to get an information about the errors that occurred during the indexing process. The indexing response attachment has MIME type `application/x.aidial-rag.indexing-response+json` and follows the [Indexing response schema](./indexing_response.generated.schema.json).

Example of response message with successful indexing results for the above request:
```json
{
    "role": "assistant",
    "custom_content": {
        "attachments": [
            {
                "type": "application/x.aidial-rag.index.v0",
                "url": "files/<dial-rag bucket>/<path inside dial-rag bucket>/index.bin",
                "reference_url": "files/<bucket>/my_document.pdf"
            },
            {
                "type": "application/x.aidial-rag.indexing-response+json",
                "data": "{\"indexing_result\":{}}"
            }
        ]
    }
}
```

Additionally, the response will contain the [Stages](https://docs.dialx.ai/tutorials/developers/chat/chat-objects#stages) with the progress of the indexing process in the same way as the regular DIAL RAG response. The stages will be dynamically updated if the request is run with the `stream` parameter set to `true`.

Since the desired index file location was not specified in the request, the DIAL RAG will store the index files in the DIAL RAG bucket with a path based on the document URL. You can use the `reference_url` field of the index attachment to find the original document. You can use the `url` field to access the index file in the DIAL storage to copy it to your own storage if needed.

> [!NOTE]
> The internal structure of the index files is not documented and is not intended to be used directly. The index files are meant to be read by the DIAL RAG API. You should use the DIAL RAG API to retrieve the indexed documents or to run the retrieval requests.

In case of errors during the indexing process, there will be no index attachments in the response, but the indexing response JSON will contain the errors that occurred during the indexing process.

Example of the indexing response JSON in case of if `my_document.custom_format` was used instead `my_document.pdf`:
```json
{
    "indexing_result": {
        "files/<bucket>/my_document.custom_format": {
            "errors": [
                {
                    "message": "Unable to load document content. Try another document format."
                }
            ]
        }
    }
}
```

To specify the desired location for the index files, you can pass the indexing attachment together with the document in the request, specifying the `url` field to point to the desired location in the DIAL storage. The DIAL RAG will use this location to store the index files.

The specified index file location should be a valid URL in the DIAL storage, and should be available for write access for the DIAL RAG in scope of the request.
One of the ways to achieve this is to use [per-request key](https://docs.dialx.ai/platform/core/per-request-keys) and `appdata` folder in your bucket to store the index files. The DIAL RAG will have an access to the `appdata/dial-rag` folder in your bucket, and you can use it to store the index files.

> [!NOTE]
> The DIAL RAG will not allow you to specify the custom index location within the DIAL RAG bucket, because the paths within the DIAL RAG bucket are managed by the DIAL RAG itself, and we want to avoid conflicts with the existing index files.

Example of the indexing request for a single `my_document.pdf` document with a specified index file location:
```json
{
    "custom_fields": {
        "configuration": {
            "request": {
                "type": "indexing"
            }
        }
    },
    "messages": [
        {
            "role": "user",
            "custom_content": {
                "attachments": [
                    {
                        "type": "application/pdf",
                        "url": "files/<bucket>/my_document.pdf"
                    },
                    {
                        "type": "application/x.aidial-rag.index.v0",
                        "url": "files/<bucket>/appdata/my_document.index",
                        "reference_url": "files/<bucket>/my_document.pdf"
                    }
                ]
            }
        }
    ]
}
```

You can look into [Indexing API Example](./indexing_api_example.ipynb) notebook for a complete example of the indexing request using OpenAI Python SDK.


### Retrieval Request

The retrieval request is a `/chat/completion` request with `custom_fields.configuration.request.type` field to `retrieval` in the request body.
You should attach the documents to be retrieved as a list of index attachments in the `custom_content.attachments` field.

Optionally, you can specify the index attachments to use for the retrieval in the `custom_content.attachments` field. If no index attachments are specified, the DIAL RAG will automatically look for the index files for the documents within it's own bucket, and will run the indexing process if the documents were not indexed before. If the index attachments are specified, the DIAL RAG will use them to retrieve the relevant document chunks without running the indexing process.

Example of the retrieval request for a single `my_document.pdf` document:
```json
{
    "custom_fields": {
        "configuration": {
            "request": {
                "type": "retrieval"
            }
        }
    },
    "messages": [
        {
            "role": "user",
            "content": "Text of the user query to retrieve relevant document chunks.",
            "custom_content": {
                "attachments": [
                    {
                        "type": "application/pdf",
                        "url": "files/<bucket>/my_document.pdf"
                    }
                ]
            }
        }
    ]
}
```

The response for this request will have a message with an empty content (because the generation of the final response is not run). The retrieval response will be as a JSON document in the attachment with MIME type `application/x.aidial-rag.retrieval-response+json` and follows the [Retrieval response schema](./retrieval_response.generated.schema.json).

Example of the retrieval response JSON for the above request:
```json
{
    "chunks": [
        {
            "attachment_url": "files/<bucket>/my_document.pdf",
            "source": {
                "url": "files/<bucket>/my_document.pdf#page=3",
                "display_name": "my_document.pdf"
            },
            "text": "The text of the retrieved document chunk.",
            "page": {
                "number": 3,
                "image_index": 0
            }
        },
        ...
    ],
    "images": [
        {
            "data": "<base64-encoded-image-data>",
            "mime_type": "image/png"
        },
        ...
    ],
    "indexing_result": {}
}
```

The retrieval response JSON contains two lists:
- **`chunks`** - a list of retrieved document chunks in the order of relevance to the user query. Each chunk contains:
  - **`attachment_url`** - the URL of the attached document, the chunk belongs to. Exactly matches with the `attachment.url` field in the request.
  - **`source`** - the source this chunk belongs to. The source could be a document or some part of the document, like a page or a section. The source object contains:
    - **`url`** - the URL of the source document or part of the document, intended to be used to access the document. For example, to open the particular page of the document in the DIAL Chat UI or in the browser.
    - **`display_name`** - a human-readable name of the source, which is usually the name of the document.
  - **`text`** - the text content of the retrieved document chunk, which could be provided to the LLM for response generation.
  - **`page`** - represents the page for this chunk. If the DIAL RAG does not support pages for the document format, this field will be `null`.
    - **`number`** - the page number in the original document.
    - **`image_index`** - an index of the image of the page in the `images` list. If the DIAL RAG does not support extraction of page images for the document format, this field will be `null`.
- **`images`** - a list of images extracted the document relevant to the retrieved chunks. Each image contains:
  - **`data`** - the base64-encoded image data.
  - **`mime_type`** - the MIME type of the image. Only `image/png` is currently supported.

If the retrieval request triggers indexing process, the retrieval response JSON also may contains `indexing_result` to report indexing errors with the same format as for [Indexing Request](#indexing-request). For more details see [Indexing errors](#indexing-errors) section.

Additionally, the response will contain the [Stages](https://docs.dialx.ai/tutorials/developers/chat/chat-objects#stages) with the progress of the indexing (if needed) and retrieval process in the same way as the regular DIAL RAG response. The stages will be dynamically updated if the request is run with the `stream` parameter set to `true`.

You can look into [Retrieval API Example](./retrieval_api_example.ipynb) notebook for an example of how to do the retrieval request using OpenAI Python SDK and how to use the retrieval results in your custom LLM generation.


### Indexing errors

The `indexing_result` field of the indexing response or retrieval response will contain the details of any indexing errors that occurred during the request. This field will include the following information:

- `message` - a human-readable error message.
- `type` - (optional) an error code that can be used to programmatically identify the known error. The `type` field will be missing if the error is not one of the predefined error types.

There are following values for `error.type`:
- `index_missing` - The specified index file was not found and DIAL RAG is unable to continue the process without the index file.
- `index_incompatible` - The index is incompatible with the current DIAL RAG version and settings, and DIAL RAG is unable to continue the process without re-indexing the document.


Example of an indexing error response:
```json
{
    "indexing_result": {
        "files/<bucket>/my_document.pdf": {
            "errors": [
                {
                    "message": "Index is incompatible with current version of RAG.",
                    "type": "index_incompatible",
                }
            ]
        }
    }
}
```

For more details look at the [Indexing response schema](./indexing_response.generated.schema.json) and [Retrieval response schema](./retrieval_response.generated.schema.json).
